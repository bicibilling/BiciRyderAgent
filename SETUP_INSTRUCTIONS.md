# üö¥‚Äç‚ôÇÔ∏è BICI AI Voice Agent System - Setup Instructions

This document provides comprehensive setup instructions for the BICI AI Voice Agent System.

## üéØ Overview

The BICI AI Voice Agent System is a complete solution for bike stores that includes:

- **ElevenLabs AI Voice Agent** with server tools
- **Real-time integrations** with Shopify, HubSpot CRM, and Google Calendar  
- **Webhook handlers** for real-time data synchronization
- **Security and monitoring** built-in
- **Multi-language support** (English/French)

## üöÄ Quick Start

### 1. Initial Setup

```bash
# Clone the repository
git clone <your-repo-url>
cd bici

# Run the automated setup script
npm run setup
```

The setup script will:
- ‚úÖ Check Node.js version (requires 18+)
- üìÅ Create necessary directories
- üîß Generate `.env` file from template
- üì¶ Install dependencies
- üß™ Set up testing configuration
- üìñ Create documentation files

### 2. Configure Environment Variables

Edit the `.env` file with your service credentials:

```bash
# Required - Generated automatically
SECRET_KEY=<auto-generated>
SERVER_TOOLS_API_KEY=<auto-generated>

# Required Services
UPSTASH_REDIS_URL=redis://your-redis-url
UPSTASH_REDIS_TOKEN=your-redis-token
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
ELEVENLABS_API_KEY=your-elevenlabs-api-key
ELEVENLABS_AGENT_ID=your-agent-id

# Integration Services
SHOPIFY_SHOP_DOMAIN=your-shop.myshopify.com
SHOPIFY_ACCESS_TOKEN=your-shopify-token
HUBSPOT_ACCESS_TOKEN=your-hubspot-token
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REFRESH_TOKEN=your-google-refresh-token
```

### 3. Start Development Server

```bash
# Start in development mode with auto-reload
npm run dev

# Or start in production mode
npm start
```

The server will start on `http://localhost:3000`

### 4. Verify Setup

Visit these endpoints to verify everything is working:

- **Health Check**: `GET http://localhost:3000/health`
- **System Config**: `GET http://localhost:3000/api/admin/config` (requires API key)
- **Test Integrations**: `POST http://localhost:3000/api/admin/test-integrations` (requires API key)

## üîß Service Configuration

### ElevenLabs Setup

1. **Create Agent**: Create an AI agent in your ElevenLabs dashboard
2. **Configure Server Tools**: Add the server tools from this system to your agent
3. **Set Webhook**: Point conversation webhooks to `https://yourdomain.com/api/webhooks/elevenlabs/conversation`

#### Server Tools Configuration

Copy these server tool configurations into your ElevenLabs agent:

**Order Status Lookup**:
```json
{
  "name": "check_order_status",
  "url": "https://yourdomain.com/api/server-tools/shopify/orders/lookup",
  "method": "POST",
  "authentication": {
    "type": "bearer_token",
    "token": "YOUR_SERVER_TOOLS_API_KEY"
  }
}
```

**Customer Search**:
```json
{
  "name": "search_customer_crm",
  "url": "https://yourdomain.com/api/server-tools/hubspot/contacts/search",
  "method": "POST",
  "authentication": {
    "type": "bearer_token", 
    "token": "YOUR_SERVER_TOOLS_API_KEY"
  }
}
```

**Appointment Booking**:
```json
{
  "name": "book_service_appointment",
  "url": "https://yourdomain.com/api/server-tools/calendar/book",
  "method": "POST",
  "authentication": {
    "type": "bearer_token",
    "token": "YOUR_SERVER_TOOLS_API_KEY"
  }
}
```

### Shopify Setup

1. **Create Private App**: In Shopify Admin ‚Üí Apps ‚Üí App and sales channel settings ‚Üí Develop apps
2. **Set Permissions**: Grant read/write access to orders, customers, and products
3. **Configure Webhooks**: Set up webhooks pointing to `https://yourdomain.com/api/webhooks/shopify/orders`

### HubSpot Setup

1. **Create Private App**: HubSpot ‚Üí Settings ‚Üí Integrations ‚Üí Private Apps
2. **Set Scopes**: Grant access to contacts, deals, tickets
3. **Configure Webhooks**: Point to `https://yourdomain.com/api/webhooks/hubspot/contacts`

### Google Calendar Setup

1. **Google Cloud Console**: Create project and enable Calendar API
2. **OAuth Consent**: Configure OAuth consent screen
3. **Credentials**: Create OAuth 2.0 client ID
4. **Generate Refresh Token**: Use OAuth playground to get refresh token

### Supabase Database Schema

Create these tables in your Supabase database:

```sql
-- Organizations table
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  phone_number VARCHAR(20),
  settings JSONB DEFAULT '{"timezone": "America/Toronto"}'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Leads table
CREATE TABLE leads (
  id VARCHAR(255) PRIMARY KEY,
  organization_id UUID REFERENCES organizations(id),
  customer_name VARCHAR(255),
  phone_number_normalized VARCHAR(20),
  email VARCHAR(255),
  lead_status VARCHAR(50) DEFAULT 'new',
  lead_source VARCHAR(100),
  bike_interest JSONB DEFAULT '{}'::jsonb,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Conversations table
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(id),
  lead_id VARCHAR(255) REFERENCES leads(id),
  phone_number_normalized VARCHAR(20),
  status VARCHAR(50) DEFAULT 'active',
  started_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  ended_at TIMESTAMP WITH TIME ZONE,
  duration_ms INTEGER,
  metadata JSONB DEFAULT '{}'::jsonb
);

-- Webhook events table
CREATE TABLE webhook_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source VARCHAR(50) NOT NULL,
  event_type VARCHAR(100) NOT NULL,
  data JSONB NOT NULL,
  processed_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

## üîê Security Configuration

### API Keys

The system uses API key authentication for server tools:

- **SERVER_TOOLS_API_KEY**: Used by ElevenLabs to authenticate server tool requests
- Include as `Authorization: Bearer YOUR_API_KEY` header

### Webhook Security

Each integration has its own webhook authentication:

- **ElevenLabs**: Uses webhook secret in `Authorization` header
- **Shopify**: Uses HMAC signature in `X-Shopify-Hmac-Sha256` header
- **HubSpot**: Uses signature in `X-HubSpot-Signature` header

### Rate Limiting

Configured rate limits:
- **General API**: 100 requests per 15 minutes
- **Server Tools**: 300 requests per minute
- **Webhooks**: 60 requests per minute

## üß™ Testing

### Run Tests

```bash
# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run specific test file
npm test -- --testPathPattern=integration.test.js
```

### Test Individual Integrations

```bash
# Test with curl
curl -X POST http://localhost:3000/api/admin/test-integrations \
  -H "Authorization: Bearer YOUR_SERVER_TOOLS_API_KEY" \
  -H "Content-Type: application/json"
```

### Test Server Tools

```bash
# Test order lookup
curl -X POST http://localhost:3000/api/server-tools/shopify/orders/lookup \
  -H "Authorization: Bearer YOUR_SERVER_TOOLS_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"identifier": "+1234567890", "identifier_type": "phone"}'

# Test customer search  
curl -X POST http://localhost:3000/api/server-tools/hubspot/contacts/search \
  -H "Authorization: Bearer YOUR_SERVER_TOOLS_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"phone_number": "+1234567890"}'

# Test appointment availability
curl -X POST http://localhost:3000/api/server-tools/calendar/availability \
  -H "Authorization: Bearer YOUR_SERVER_TOOLS_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"service_type": "bike_repair"}'
```

## üìä Monitoring

### Health Checks

- **Basic Health**: `GET /health`
- **Detailed Health**: `GET /api/admin/health` (requires auth)

### Logs

Logs are written to the `logs/` directory:
- `combined.log` - All logs
- `error.log` - Error logs only
- `integrations.log` - Integration-specific logs

### Metrics

The system tracks:
- Request/response metrics
- Integration call success rates
- Error rates and types
- Performance metrics

Access metrics via:
- Redis keys: `metrics:*`
- Admin endpoints with proper authentication

## üöÄ Production Deployment

### Environment Setup

1. **Set NODE_ENV**: `NODE_ENV=production`
2. **Configure Logging**: Set appropriate `LOG_LEVEL`
3. **Database**: Ensure production database is configured
4. **Redis**: Use production Redis instance (Upstash recommended)

### Docker Deployment

```bash
# Build image
docker build -t bici-ai .

# Run container
docker run -d \
  --name bici-ai \
  -p 3000:3000 \
  --env-file .env \
  -v $(pwd)/logs:/app/logs \
  bici-ai

# Or use docker-compose
docker-compose up -d
```

### Scaling Considerations

- **Stateless Design**: App can be horizontally scaled
- **Redis**: Shared session store allows multiple instances
- **Database**: Supabase handles scaling automatically
- **Load Balancer**: Use nginx or cloud load balancer

## üîß Troubleshooting

### Common Issues

**1. Port Already in Use**
```bash
# Kill process on port 3000
lsof -ti:3000 | xargs kill -9
```

**2. Database Connection Issues**
- Check environment variables
- Verify network connectivity
- Check database credentials

**3. Integration Failures**
- Verify API keys are valid
- Check rate limits
- Review webhook configurations

**4. Memory Issues**
- Monitor memory usage with `/health`
- Increase container memory limits
- Check for memory leaks in logs

### Debug Mode

Enable debug logging:
```bash
LOG_LEVEL=debug npm run dev
```

### Support

For issues or questions:
1. Check the logs in `logs/` directory
2. Verify configuration with `/api/admin/config`
3. Test integrations with `/api/admin/test-integrations`
4. Review the error logs for specific error messages

## üìã Checklist

### Pre-Production

- [ ] All environment variables configured
- [ ] Database tables created
- [ ] Integration services configured
- [ ] Webhook endpoints set up
- [ ] ElevenLabs agent configured with server tools
- [ ] Tests passing
- [ ] Security review completed
- [ ] Monitoring set up

### Go-Live

- [ ] DNS configured
- [ ] SSL certificates installed
- [ ] Production environment variables set
- [ ] Backup strategy implemented
- [ ] Monitoring dashboards configured
- [ ] On-call procedures documented

## üéâ Success!

Your BICI AI Voice Agent System should now be fully operational! The system will:

- ‚úÖ Handle incoming calls through ElevenLabs + Twilio
- ‚úÖ Look up customer information in HubSpot CRM
- ‚úÖ Check order status in Shopify
- ‚úÖ Book appointments in Google Calendar
- ‚úÖ Create and update customer leads
- ‚úÖ Provide real-time monitoring and logging

For ongoing maintenance, monitor the health endpoints and review logs regularly.