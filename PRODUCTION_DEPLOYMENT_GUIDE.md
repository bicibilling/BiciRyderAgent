# BICI AI Voice Agent System - Production Deployment Guide

## Overview

This guide provides comprehensive instructions for deploying the BICI AI Voice Agent System to production using Render.com. The system includes a complete Express.js API backend with real-time WebSocket communication, authentication, and integrations with ElevenLabs, Twilio, Shopify, HubSpot, and Google Calendar.

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   React Client  │    │  Express API    │    │   External APIs │
│   (Frontend)    │◄──►│   (Backend)     │◄──►│  ElevenLabs,    │
│                 │    │                 │    │  Twilio, etc.   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   Supabase DB   │
                       │   (PostgreSQL)  │
                       └─────────────────┘
```

## Prerequisites

### Required Accounts & Services

1. **Render.com Account** - For hosting
2. **Supabase Account** - For PostgreSQL database
3. **Upstash Account** - For Redis cache
4. **ElevenLabs Account** - For AI voice conversations
5. **Twilio Account** - For phone/SMS services
6. **Shopify Store** (optional) - For e-commerce integration
7. **HubSpot Account** (optional) - For CRM integration
8. **Google Cloud Console** (optional) - For Calendar integration

### Required API Keys & Credentials

Collect the following credentials before deployment:

#### Supabase
- `SUPABASE_URL`
- `SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`

#### Upstash Redis
- `UPSTASH_REDIS_URL`
- `UPSTASH_REDIS_TOKEN`

#### ElevenLabs
- `ELEVENLABS_API_KEY`
- `ELEVENLABS_AGENT_ID`
- `ELEVENLABS_PHONE_NUMBER_ID`

#### Twilio
- `TWILIO_ACCOUNT_SID`
- `TWILIO_AUTH_TOKEN`
- `TWILIO_PHONE_NUMBER`

#### Shopify (Optional)
- `SHOPIFY_ACCESS_TOKEN`
- `SHOPIFY_SHOP_DOMAIN`

#### HubSpot (Optional)
- `HUBSPOT_ACCESS_TOKEN`

#### Google Calendar (Optional)
- `GOOGLE_CLIENT_ID`
- `GOOGLE_CLIENT_SECRET`
- `GOOGLE_REDIRECT_URI`

## Step-by-Step Deployment

### Step 1: Database Setup (Supabase)

1. **Create Supabase Project**
   - Visit [supabase.com](https://supabase.com)
   - Create new project
   - Note down the URL and keys

2. **Run Database Schema**
   ```sql
   -- Execute the SQL from database/schema.sql
   -- This creates all necessary tables and indexes
   ```

3. **Set up Row Level Security (RLS)**
   ```sql
   -- Execute the SQL from database/policies/rls_policies.sql
   -- This ensures proper data isolation between organizations
   ```

### Step 2: Redis Setup (Upstash)

1. **Create Upstash Redis Database**
   - Visit [upstash.com](https://upstash.com)
   - Create new Redis database
   - Choose region closest to your users
   - Note down the URL and token

### Step 3: External Service Configuration

#### ElevenLabs Setup
1. Create ElevenLabs account
2. Create conversational AI agent
3. Configure knowledge base with bike store information
4. Note agent ID and phone number ID

#### Twilio Setup
1. Create Twilio account
2. Purchase phone number
3. Configure webhooks to point to your Render deployment
4. Set up SMS and voice capabilities

### Step 4: Render Deployment

1. **Fork/Clone Repository**
   ```bash
   git clone <your-repo-url>
   cd bici-ai-system
   ```

2. **Connect to Render**
   - Visit [render.com](https://render.com)
   - Connect your GitHub repository
   - Create new web service

3. **Configure Environment Variables**
   
   In the Render dashboard, set all environment variables:

   ```bash
   # Server Configuration
   NODE_ENV=production
   PORT=3000
   HOST=0.0.0.0
   LOG_LEVEL=info

   # Authentication (auto-generated by Render)
   JWT_SECRET=<auto-generated>
   JWT_EXPIRY=24h
   REFRESH_TOKEN_EXPIRY=7d

   # Database
   SUPABASE_URL=<your-supabase-url>
   SUPABASE_ANON_KEY=<your-anon-key>
   SUPABASE_SERVICE_ROLE_KEY=<your-service-key>

   # Redis
   UPSTASH_REDIS_URL=<your-redis-url>
   UPSTASH_REDIS_TOKEN=<your-redis-token>

   # ElevenLabs
   ELEVENLABS_API_KEY=<your-api-key>
   ELEVENLABS_AGENT_ID=<your-agent-id>
   ELEVENLABS_PHONE_NUMBER_ID=<your-phone-id>
   ELEVENLABS_WEBHOOK_SECRET=<auto-generated>

   # Twilio
   TWILIO_ACCOUNT_SID=<your-account-sid>
   TWILIO_AUTH_TOKEN=<your-auth-token>
   TWILIO_PHONE_NUMBER=<your-phone-number>

   # Shopify
   SHOPIFY_ACCESS_TOKEN=<your-access-token>
   SHOPIFY_SHOP_DOMAIN=<your-shop>.myshopify.com
   SHOPIFY_WEBHOOK_SECRET=<auto-generated>

   # HubSpot
   HUBSPOT_ACCESS_TOKEN=<your-access-token>
   HUBSPOT_WEBHOOK_SECRET=<auto-generated>

   # Google Calendar
   GOOGLE_CLIENT_ID=<your-client-id>
   GOOGLE_CLIENT_SECRET=<your-client-secret>
   GOOGLE_REDIRECT_URI=<your-redirect-uri>

   # Organization Settings
   DEFAULT_ORGANIZATION_ID=org_bici_main
   DEFAULT_TIMEZONE=America/Toronto

   # CORS
   FRONTEND_URL=<your-frontend-url>
   ```

4. **Deploy**
   - Render will automatically deploy when you push to main branch
   - Monitor deployment logs for any issues

### Step 5: Webhook Configuration

After deployment, configure webhooks in external services:

#### ElevenLabs Webhooks
```
URL: https://your-app.onrender.com/api/webhooks/elevenlabs/conversation
Events: conversation_started, conversation_ended, user_transcript, agent_response
```

#### Twilio Webhooks
```
Voice URL: https://your-app.onrender.com/api/webhooks/twilio/call-status
SMS URL: https://your-app.onrender.com/api/webhooks/twilio/sms
```

#### Shopify Webhooks (Optional)
```
URL: https://your-app.onrender.com/api/webhooks/shopify/orders
Events: orders/create, orders/updated, orders/paid
```

#### HubSpot Webhooks (Optional)
```
URL: https://your-app.onrender.com/api/webhooks/hubspot/contacts
Events: contact.creation, contact.propertyChange
```

### Step 6: Frontend Deployment

1. **Configure Frontend Environment**
   ```bash
   # In client/.env.production
   REACT_APP_API_URL=https://your-api.onrender.com
   REACT_APP_WS_URL=wss://your-api.onrender.com
   REACT_APP_ENVIRONMENT=production
   ```

2. **Deploy Frontend**
   - Frontend will be deployed as a static site
   - Render will automatically build and deploy

### Step 7: Testing & Verification

1. **Health Check**
   ```bash
   curl https://your-app.onrender.com/health
   ```

2. **API Authentication**
   ```bash
   curl -X POST https://your-app.onrender.com/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"admin@bici.bike","password":"password123","organizationId":"org_bici_main"}'
   ```

3. **WebSocket Connection**
   - Open browser developer tools
   - Navigate to your frontend
   - Check WebSocket connection in Network tab

4. **Integration Tests**
   ```bash
   curl https://your-app.onrender.com/api/integrations/test
   ```

## Production Configuration

### Security Checklist

- [ ] JWT secret is auto-generated and secure
- [ ] All webhook secrets are configured
- [ ] CORS is properly configured
- [ ] Rate limiting is enabled
- [ ] Input validation is active
- [ ] HTTPS is enforced
- [ ] Security headers are set

### Performance Optimization

1. **Database Indexing**
   - Execute `database/indexes/performance_indexes.sql`
   - Monitor query performance

2. **Redis Caching**
   - Configure appropriate cache TTLs
   - Monitor cache hit rates

3. **Auto-scaling**
   - Set appropriate min/max instances
   - Monitor CPU and memory usage

### Monitoring & Logging

1. **Application Logs**
   - Render provides built-in log aggregation
   - Set LOG_LEVEL to 'info' for production

2. **Error Tracking**
   - Monitor application errors in Render dashboard
   - Set up alerts for critical errors

3. **Performance Monitoring**
   - Monitor response times
   - Track API endpoint usage

## Maintenance & Updates

### Regular Tasks

1. **Database Maintenance**
   - Weekly: Review slow queries
   - Monthly: Analyze table sizes and optimize

2. **Security Updates**
   - Monthly: Update dependencies
   - Quarterly: Review security settings

3. **Integration Health**
   - Daily: Monitor webhook delivery
   - Weekly: Test all integrations

### Backup Strategy

1. **Database Backups**
   - Supabase provides automatic backups
   - Test restore procedures monthly

2. **Configuration Backups**
   - Export environment variables
   - Document webhook configurations

## Troubleshooting

### Common Issues

1. **Service Won't Start**
   - Check environment variables
   - Review deployment logs
   - Verify database connectivity

2. **WebSocket Connections Failing**
   - Check CORS configuration
   - Verify WebSocket URL format
   - Review proxy settings

3. **Webhook Delivery Issues**
   - Verify webhook URLs are accessible
   - Check webhook signatures
   - Review rate limiting settings

4. **Database Connection Issues**
   - Verify Supabase credentials
   - Check connection pool settings
   - Review database logs

### Support Contacts

- **Render Support**: [render.com/support](https://render.com/support)
- **Supabase Support**: [supabase.com/support](https://supabase.com/support)
- **ElevenLabs Support**: [elevenlabs.io/support](https://elevenlabs.io/support)

## Cost Optimization

### Render Pricing Tiers

1. **Starter Plan** ($7/month)
   - Good for testing and low traffic
   - 512MB RAM, 0.1 CPU

2. **Standard Plan** ($25/month)
   - Recommended for production
   - 2GB RAM, 1 CPU
   - Auto-scaling capabilities

3. **Pro Plan** ($85/month)
   - High traffic applications
   - 8GB RAM, 4 CPU
   - Advanced features

### Cost Monitoring

- Monitor monthly usage in Render dashboard
- Set up billing alerts
- Review resource utilization regularly

## Scaling Considerations

### Horizontal Scaling

- Configure auto-scaling in render.yaml
- Set appropriate min/max instances
- Monitor performance metrics

### Database Scaling

- Supabase handles database scaling automatically
- Consider read replicas for high read workloads
- Monitor connection pool usage

### CDN & Caching

- Use Render's built-in CDN for static assets
- Implement Redis caching for frequently accessed data
- Consider adding CloudFlare for additional performance

## Security Best Practices

### Environment Variables

- Never commit secrets to Git
- Use Render's secret management
- Rotate keys regularly

### API Security

- Implement rate limiting
- Validate all inputs
- Use HTTPS everywhere
- Set proper CORS policies

### Database Security

- Use Supabase Row Level Security
- Implement proper user permissions
- Audit database access regularly

---

## Quick Start Commands

```bash
# Clone repository
git clone <your-repo-url>
cd bici-ai-system

# Install dependencies
npm install

# Set up environment variables
cp .env.example .env
# Edit .env with your values

# Start development server
npm run dev

# Deploy to production
git push origin main
# Render will auto-deploy
```

## API Endpoints Reference

### Authentication
- `POST /api/auth/login` - User login
- `POST /api/auth/refresh` - Refresh token
- `GET /api/auth/verify` - Verify token
- `POST /api/auth/logout` - User logout

### Dashboard
- `GET /api/dashboard/overview` - Dashboard data
- `GET /api/dashboard/active-conversations` - Active calls
- `GET /api/dashboard/metrics/realtime` - Real-time metrics
- `GET /api/dashboard/alerts` - System alerts

### Conversations
- `GET /api/conversations` - List conversations
- `GET /api/conversations/:id` - Get conversation details
- `POST /api/conversations/:id/messages` - Send message
- `POST /api/conversations/:id/takeover` - Human takeover
- `PATCH /api/conversations/:id/notes` - Update notes

### Analytics
- `GET /api/analytics/overview` - Analytics overview
- `GET /api/analytics/calls` - Call analytics
- `GET /api/analytics/ai-performance` - AI metrics
- `GET /api/analytics/customers` - Customer insights

### Integrations
- `GET /api/integrations` - Integration status
- `POST /api/integrations/test` - Test integrations
- `GET /api/integrations/shopify/orders` - Shopify orders
- `GET /api/integrations/hubspot/contacts` - HubSpot contacts

### Admin
- `GET /api/admin/system/info` - System information
- `GET /api/admin/system/health` - System health
- `GET /api/admin/metrics` - System metrics
- `GET /api/admin/logs` - System logs

### Webhooks
- `POST /api/webhooks/elevenlabs/conversation`
- `POST /api/webhooks/twilio/call-status`
- `POST /api/webhooks/shopify/orders`
- `POST /api/webhooks/hubspot/contacts`

This deployment guide provides everything needed to successfully deploy and maintain the BICI AI Voice Agent System in production.